<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Time Machine</title>
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-100 min-h-screen flex items-center justify-center p-4">

    <!-- Main application container -->
    <div class="bg-gray-800 p-8 rounded-xl shadow-2xl max-w-4xl w-full">
        <h1 class="text-4xl md:text-5xl font-bold text-center text-teal-400 mb-6 drop-shadow-md">
            The Time Machine
        </h1>
        <p class="text-center text-gray-300 mb-8">
            Enter a date and travel back in time to see what was happening.
        </p>

        <!-- Date input form -->
        <div class="flex flex-col md:flex-row gap-4 mb-8">
            <input type="date" id="date-input"
                   class="flex-1 p-3 rounded-lg bg-gray-700 text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-teal-400 shadow-md">
            <button id="travel-btn"
                    class="bg-teal-500 hover:bg-teal-600 text-white font-semibold py-3 px-6 rounded-lg shadow-md transition-colors duration-300 transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-teal-400 focus:ring-offset-2 focus:ring-offset-gray-800">
                Travel
            </button>
        </div>

        <!-- Loading indicator -->
        <div id="loading-indicator" class="hidden flex justify-center items-center py-10">
            <div class="animate-spin rounded-full h-12 w-12 border-4 border-gray-600 border-t-teal-400"></div>
        </div>

        <!-- Main content display area -->
        <div id="content-display" class="hidden grid grid-cols-1 md:grid-cols-2 gap-8">

            <!-- Historical Events Section (LLM-Powered) -->
            <div id="wikipedia-section" class="bg-gray-700 p-6 rounded-lg shadow-inner border-l-4 border-teal-500">
                <h2 class="text-2xl font-bold text-white mb-4">Historical Events</h2>
                <div id="wikipedia-content" class="space-y-4">
                    <!-- Dynamic content will be injected here -->
                </div>
            </div>

            <!-- News Headline Section (LLM-Powered) -->
            <div id="nyt-section" class="bg-gray-700 p-6 rounded-lg shadow-inner border-l-4 border-yellow-500">
                <h2 class="text-2xl font-bold text-white mb-4">From the Front Page</h2>
                <div id="nyt-content">
                    <!-- Dynamic content will be injected here -->
                </div>
            </div>

            <!-- Recipe Section (The Meal DB) -->
            <div id="recipe-section" class="bg-gray-700 p-6 rounded-lg shadow-inner border-l-4 border-pink-500">
                <h2 class="text-2xl font-bold text-white mb-4">A Taste of the Past</h2>
                <div id="recipe-content">
                    <!-- Dynamic content will be injected here -->
                </div>
            </div>

            <!-- Music Section (Simulated) -->
            <div id="music-section" class="bg-gray-700 p-6 rounded-lg shadow-inner border-l-4 border-blue-500">
                <h2 class="text-2xl font-bold text-white mb-4">Top of the Charts</h2>
                <div id="music-content">
                    <!-- Dynamic content will be injected here -->
                </div>
            </div>

        </div>

        <!-- Message/Error Box -->
        <div id="message-box" class="hidden mt-8 bg-red-800 text-white p-4 rounded-lg shadow-md text-center">
            <span id="message-text"></span>
            <button id="close-message-btn" class="ml-4 text-white font-bold">&times;</button>
        </div>
    </div>

    <script>
        // DOM element references
        const dateInput = document.getElementById('date-input');
        const travelBtn = document.getElementById('travel-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const contentDisplay = document.getElementById('content-display');
        const wikipediaContent = document.getElementById('wikipedia-content');
        const nytContent = document.getElementById('nyt-content');
        const recipeContent = document.getElementById('recipe-content');
        const musicContent = document.getElementById('music-content');
        const messageBox = document.getElementById('message-box');
        const messageText = document.getElementById('message-text');
        const closeMessageBtn = document.getElementById('close-message-btn');
        
        // This key will be automatically provided at runtime.
        const apiKey = "AIzaSyDfXG_QF0nwpYLMHO-8Z8MvXg1vAVm1Q_Y";
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

        // The Meal DB provides a test key "1" for development.
        const MEALDB_API_KEY = "1";

        // Set the default date to today for convenience
        dateInput.valueAsDate = new Date();

        // Event listener for the "Travel" button
        travelBtn.addEventListener('click', async () => {
            const dateString = dateInput.value;
            if (!dateString) {
                showMessage('Please enter a valid date.');
                return;
            }

            clearContent();
            toggleLoading(true);
            
            const date = new Date(dateString);
            const year = date.getFullYear();
            const month = date.getMonth() + 1;
            const day = date.getDate();

            try {
                const [historicalData, recipeData, musicData] = await Promise.allSettled([
                    fetchHistoricalData(year, month, day),
                    fetchRecipeData(MEALDB_API_KEY, year),
                    fetchMusicData(year)
                ]);

                if (historicalData.status === 'fulfilled') {
                    displayLLMData(historicalData.value);
                } else {
                    console.error('LLM API failed:', historicalData.reason);
                    showMessage('Failed to retrieve historical data. Please try again.');
                }
                
                if (recipeData.status === 'fulfilled') {
                    displayRecipeData(recipeData.value);
                } else {
                    console.error('Recipe API failed:', recipeData.reason);
                    displayRecipeData({ title: 'A culinary mystery...', instructions: 'No recipe available for this era.' });
                }

                if (musicData.status === 'fulfilled') {
                    displayMusicData(musicData.value);
                } else {
                    console.error('Music API failed:', musicData.reason);
                    displayMusicData({ title: 'The jukebox is silent...', artist: 'No music data available.' });
                }

            } catch (error) {
                console.error('An error occurred during API calls:', error);
                showMessage('An unexpected error occurred. Please try again.');
            } finally {
                toggleLoading(false);
                contentDisplay.classList.remove('hidden');
            }
        });

        closeMessageBtn.addEventListener('click', () => {
            messageBox.classList.add('hidden');
        });

        // --- NEW LLM-POWERED API CALL FUNCTION ---

        async function fetchHistoricalData(year, month, day) {
            const date = new Date(year, month - 1, day).toLocaleDateString('en-us', { year: 'numeric', month: 'long', day: 'numeric' });
            const prompt = `Give me a JSON object with two fields: "events" (an array of 3-4 historical events from a day like ${date}) and "headline" (a single, main news headline from that day). For example, use a structure like this: {"events": ["event 1", "event 2"], "headline": "A major headline for the day"}. Keep the events brief and concise.`;

            const payload = {
                contents: [{ parts: [{ text: prompt }] }],
                generationConfig: {
                    responseMimeType: "application/json",
                    responseSchema: {
                        type: "OBJECT",
                        properties: {
                            "events": {
                                "type": "ARRAY",
                                "items": { "type": "STRING" }
                            },
                            "headline": { "type": "STRING" }
                        },
                        "propertyOrdering": ["events", "headline"]
                    }
                }
            };
            
            let retryCount = 0;
            const maxRetries = 3;
            let response;
            
            while (retryCount < maxRetries) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    if (response.ok) {
                        const result = await response.json();
                        const jsonText = result.candidates[0].content.parts[0].text;
                        return JSON.parse(jsonText);
                    }
                } catch (error) {
                    console.error(`Attempt ${retryCount + 1} failed:`, error);
                }
                
                retryCount++;
                if (retryCount < maxRetries) {
                    await new Promise(resolve => setTimeout(resolve, Math.pow(2, retryCount) * 1000));
                }
            }
            throw new Error('Failed to fetch from LLM after multiple retries.');
        }


        // --- Other API CALL FUNCTIONS (These are working) ---

        /**
         * Fetches a random recipe. Note: The MealDB API doesn't support searching by date,
         * so this function provides a creative, era-based placeholder.
         * @param {string} apiKey The Meal DB API key.
         * @param {number} year The year.
         * @returns {Promise<object>} A promise that resolves with data from the API.
         */
        async function fetchRecipeData(apiKey, year) {
            // The MealDB API is simple to use with a test key
            const url = `https://www.themealdb.com/api/json/v1/${apiKey}/random.php`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                const data = await response.json();
                const meal = data.meals[0];
                
                let title = meal.strMeal;
                let instructions = meal.strInstructions;
                let eraNote = '';

                // Add a creative note based on the year
                if (year < 1950) { eraNote = ' (A popular dish from the early 20th century!)'; }
                else if (year < 1980) { eraNote = ' (This dish was a sensation in the mid-century!)'; }
                
                return {
                    title: `${title}${eraNote}`,
                    instructions: instructions
                };
            } catch (error) {
                console.error("Failed to fetch recipe data:", error);
                throw error;
            }
        }
        
        /**
         * This function is a placeholder for a more complex music API.
         * @param {number} year The year.
         * @returns {Promise<object>} A promise that resolves with simulated data.
         */
        async function fetchMusicData(year) {
            await new Promise(resolve => setTimeout(resolve, 1100)); // Simulate a network delay
            
            if (year > 2000) return { title: 'Modern Pop Hit', artist: 'Today\'s Top Artist' };
            if (year > 1990) return { title: 'Smells Like Teen Spirit', artist: 'Nirvana' };
            if (year > 1970) return { title: 'Bohemian Rhapsody', artist: 'Queen' };
            if (year > 1950) return { title: 'Blue Suede Shoes', artist: 'Elvis Presley' };
            
            return { title: 'The jukebox is silent...', artist: 'No music data available.' };
        }

        // --- Helper Functions to Display Content ---

        function displayLLMData(data) {
            wikipediaContent.innerHTML = '';
            data.events.forEach(event => {
                const p = document.createElement('p');
                p.textContent = `â€¢ ${event}`;
                p.className = 'text-gray-200';
                wikipediaContent.appendChild(p);
            });

            nytContent.innerHTML = '';
            const h3 = document.createElement('h3');
            h3.textContent = data.headline;
            h3.className = 'text-xl font-bold mb-2';
            nytContent.appendChild(h3);
        }

        function displayRecipeData(data) {
            recipeContent.innerHTML = '';
            const h3 = document.createElement('h3');
            h3.textContent = data.title;
            h3.className = 'text-xl font-bold mb-2';
            recipeContent.appendChild(h3);
            
            const p = document.createElement('p');
            p.textContent = data.instructions.split('.').slice(0, 3).join('.') + '.';
            p.className = 'text-gray-300';
            recipeContent.appendChild(p);
        }

        function displayMusicData(data) {
            musicContent.innerHTML = '';
            const h3 = document.createElement('h3');
            h3.textContent = data.title;
            h3.className = 'text-xl font-bold mb-2';
            musicContent.appendChild(h3);

            const p = document.createElement('p');
            p.textContent = `Artist: ${data.artist}`;
            p.className = 'text-gray-300';
            musicContent.appendChild(p);
        }

        // --- UI Utility Functions ---

        function clearContent() {
            wikipediaContent.innerHTML = '';
            nytContent.innerHTML = '';
            recipeContent.innerHTML = '';
            musicContent.innerHTML = '';
            contentDisplay.classList.add('hidden');
            messageBox.classList.add('hidden');
        }

        function toggleLoading(isLoading) {
            loadingIndicator.classList.toggle('hidden', !isLoading);
        }

        function showMessage(text) {
            messageText.textContent = text;
            messageBox.classList.remove('hidden');
        }
    </script>
</body>
</html>
